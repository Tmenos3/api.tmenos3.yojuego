 var ValidationHelper = require('../helpers/CommonValidator/ValidationHelper');
 var NotNullOrUndefinedCondition = require('../helpers/CommonValidator/NotNullOrUndefinedCondition');
 var CustomCondition = require('../helpers/CommonValidator/CustomCondition');
 var config = require('../../config');
 var moment = require('moment');
 var CryptoJS = require('crypto-js');
 var ObjectId = require('mongodb').ObjectId;

class ApiService{
    constructor(UserMap, PlayerMap, MatchMap){
        var conditions = [
            new NotNullOrUndefinedCondition(UserMap, ApiService.INVALID_USERMAP()),
            new NotNullOrUndefinedCondition(PlayerMap, ApiService.INVALID_PLAYERMAP()),
            new NotNullOrUndefinedCondition(MatchMap, ApiService.INVALID_MATCHMAP())
        ];
        
        var validator = new ValidationHelper(conditions, () => {
            this._UserMap = UserMap;
            this._PlayerMap = PlayerMap;
            this._MatchMap = MatchMap; 
        }, (err) => { throw new Error(err); });

        validator.execute();
    }

    login(req){
        return new Promise((resolve, reject) => {
            var conditions = [
                new CustomCondition(() => { return this._isValidRequest(req); }, ApiService.INVALID_REQUEST()),
                new CustomCondition(() => { return this._isValidRequestBody(req); }, ApiService.INVALID_REQUEST_BODY()),
                new CustomCondition(() => { return this._isValidUsername(req); }, ApiService.INVALID_CREDENTIALS()),
                new CustomCondition(() => { return this._isValidPassword(req); }, ApiService.INVALID_CREDENTIALS())
            ];
            
            var validator = new ValidationHelper(conditions, () => { this._doAfterValidateLogin(req.body.username, req.body.password, resolve, reject) }, (err) => { reject(err); });
            validator.execute();
        });
    }

    signUp(req){
        return new Promise((resolve, reject) => {
            var conditions = [
                 new CustomCondition(() => { return this._isValidRequest(req); }, ApiService.INVALID_REQUEST()),
                 new CustomCondition(() => { return this._isValidRequestBody(req); }, ApiService.INVALID_REQUEST_BODY()),
                 new CustomCondition(() => { return this._isValidUsername(req); }, ApiService.INVALID_CREDENTIALS()),
                 new CustomCondition(() => { return this._isValidPassword(req); }, ApiService.INVALID_CREDENTIALS())
            ];
            
            var validator = new ValidationHelper(conditions, () => { this._doAfterValidateSignUp(req.body.username, req.body.password, resolve, reject) }, (err) => { reject(err); });
            validator.execute();
        });
    }

    getPlayerProfile(req){
        return new Promise((resolve, reject) => {
            var conditions = [
                new CustomCondition(() => { return this._isValidRequest(req); }, ApiService.INVALID_REQUEST()),
                new CustomCondition(() => { return this._isValidRequestUser(req); }, ApiService.INVALID_REQUEST_USER()),
                new CustomCondition(() => { return this._isValidIdUser(req); }, ApiService.UNAUTHORIZED())
            ];
            var validator = new ValidationHelper(conditions, () => { this._doAfterValidateGetUserProfile(req.user.id, resolve, reject) }, 
                                                                    (err) => { reject({ status: false, code: 400, message: err}); });
            validator.execute();
        });
    }

    getUpcomingMatches(req){
        return new Promise((resolve, reject) => {
            var conditions = [
                new CustomCondition(() => { return this._isValidRequest(req); }, ApiService.INVALID_REQUEST()),
                new CustomCondition(() => { return this._isValidRequestUser(req); }, ApiService.INVALID_REQUEST_USER()),
                new CustomCondition(() => { return this._isValidIdUser(req); }, ApiService.UNAUTHORIZED()),
                new CustomCondition(() => { return this._isValidRequestParams(req); }, ApiService.INVALID_REQUEST_PARAMS()),
                new CustomCondition(() => { return this._isValidDatefrom(req); }, ApiService.INVALID_DATEFROM())
            ];
            var validator = new ValidationHelper(conditions, () => { this._doAfterValidateGetUpcomingMatches(req.user.id, req.params.datefrom, resolve, reject) }, 
                                                                    (err) => reject({ status: false, code: 400, message: err}));
            validator.execute();
        });
    }

    _doAfterValidateLogin(username, password, resolve, reject){
        this._UserMap.findOne({username: username}, (err, userReturned) => {
            if (err){
                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
            }else{
                if (userReturned === undefined || userReturned === null){
                    reject({ status: false , message: ApiService.INVALID_CREDENTIALS()});
                }else{
                    var decryptedPassword = CryptoJS.AES.decrypt(userReturned.password, config.secret).toString(CryptoJS.enc.Utf8);
                    if (decryptedPassword != password){
                        reject({ status: false, message: ApiService.INVALID_CREDENTIALS() });
                    }else{
                        resolve({id: userReturned._id});
                    }
                }
            }
        })
    }

    _doAfterValidateGetUserProfile(idUser, resolve, reject){
        this._PlayerMap.findOne({_idUser: idUser}, (err, playerReturned) => {
            if(err){
                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
            }else{
                if (playerReturned === undefined || playerReturned === null){
                    reject({ status: false, code: 401, message: ApiService.UNAUTHORIZED() });
                }else{
                    resolve(playerReturned.profile);
                }
            }
        });
    }

    _doAfterValidateSignUp(username, password, resolve, reject){
        this._UserMap.findOne({username: username}, (err, userReturned) => {
            if (err){
                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
            }else{
                if(userReturned !== null && userReturned !== undefined){
                    reject({ status: false, message: ApiService.USERNAME_IS_ALREADY_IN_USE() });
                }else{
                    this._createUser(username, password, resolve, reject);
                }
            }
        });
    }

    _createUser(username, password, resolve, reject){
        var encriptedPasword = CryptoJS.AES.encrypt(password, config.secret);
        var user = new this._UserMap({username: username, password: encriptedPasword});
        user.save((err) => {
            if (err){
                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
            }else{
                this._createPlayer(user, resolve, reject);
            }
        });
    }

    _createPlayer(user, resolve, reject){
      var player = new this._PlayerMap({
          _idUser: user._id, 
          profile: {nickname: user.username}}
          );

      player.save((err) => {
        if(err){
            reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
        }else{
          resolve(ApiService.USER_CREATED());
        }
      });
    }

    _doAfterValidateGetUpcomingMatches(idUser, datefrom, resolve, reject){
        this._PlayerMap.findOne({_idUser: idUser}, (err, playerReturned) => {
            if(err){
                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
            }else{
                if(playerReturned === undefined || playerReturned === null){
                    reject({ status: false, code: 401, message: ApiService.UNAUTHORIZED() });
                }else{
                    this._MatchMap.find({ datetime: {$gte: new Date(datefrom).toISOString()}, confirmed: [playerReturned._id]}, 
                        (err, mathcesReturned) => {
                            if(err){
                                reject({ status: false , message: ApiService.UNEXPECTED_ERROR()});
                            }else{
                                resolve(mathcesReturned);
                            }
                        });
                }
            }
        });
    }

    _isValidRequest(req){
        return !(req === undefined || req === null);
    }

    _isValidRequestHeader(req){
        return !(req.headers === undefined || req.headers === null);
    }

    _isValidRequestBody(req){
        return !(req.body === undefined || req.body === null);
    }

    _isValidAuthorization(req){
        return !(req.headers.authorization === undefined || req.headers.authorization === null);
    }

    _isValidUsername(req){
        return !(req.body.username === undefined || req.body.username === null);
    }

    _isValidPassword(req){
        return !(req.body.password === undefined || req.body.password === null);
    }

    _isValidRequestParams(req){
        return !(req.params === undefined || req.params === null);
    }

    _isValidDatefrom(req){
        return (!(req.params.datefrom === undefined || req.params.datefrom === null)) && moment(req.params.datefrom, [moment.ISO_8601], true).isValid();
    }

    _isValidRequestUser(req){
        return !(req.user === undefined || req.user === null);
    }

    _isValidIdUser(req){
        return !(req.user.id === undefined || req.user.id === null);
    }

    static UNAUTHORIZED(){
        return 'Unauthorized';
    }

    static INVALID_REQUEST(){
        return 'Request inválido';
    }

    static INVALID_REQUEST_PARAMS(){
        return 'Los parámetros del request no son válidos.';
    }

    static INVALID_REQUEST_USER(){
        return 'EL req.user no es válido.';
    }

    static INVALID_REQUEST_BODY(){
        return 'Body request inválido';
    }

    static INVALID_USERMAP(){
        return 'El USERMAP es inválido.';
    }

    static INVALID_PLAYERMAP(){
        return 'El PLAYERMAP es inválido.';
    }

    static INVALID_MATCHMAP(){
        return 'El MATCHMAP es inválido.';
    }

    static INVALID_CALLBACK(){
        return 'Callback inválido.';
    }

    static INVALID_CREDENTIALS(){
        return 'Las credenciales no son válidas.';
    }

    static USERNAME_IS_ALREADY_IN_USE(){
        return 'El nombre de usuario ya está siendo utilizado.';
    }

    static INVALID_ID_USER(){
        return 'El id de usuario es inválido.';
    }

    static USER_CREATED(){
        return 'El usuario ha sido creado.';
    }

    static USER_DOES_NOT_EXIST(){
        return 'Usuario inexistente.';
    }

    static UNEXPECTED_ERROR(){
        return 'Error inexperado.';
    }

    static INVALID_DATEFROM(){
        return 'El parametro datefrom debe existeir en el request.params';
    }
}

module.exports = ApiService;